# 线程调度器注意事项

你通常使用线程调度器的目的

- 设计一个系统，使其在满载时，以可预测或可定义的方式工作
- 防止不重要或不受信任的应用独占系统

无论哪种情况，你都需要根据整个系统来配置线程调度器的参数。基本的考虑是

- 你应该创建多少个调度分区，以及每个分区应安装什么软件?
- 每个调度器分区应获得多少保证的CPU百分比?
- 每个调度器分区的关键预算(如果有)应该是多少?
- 时间平均窗口应该是多大? 以毫毛为单位



## 确定调度程序分区的数量及其内容

​	将功能相关的软件放于相同的分区是合理的，通常也是正确的选择。然而，自适应分区线程调度是一种决定何时不运行软件的结构化方式。因此，实际的方法是，如果软件在不同情况下需要CPU时间，则将软件分成不同的调度分区。

Note: 你能创建的最大分区数是32

例如，如果系统是一个数据包路由器，功能如下

- 路由数据包
- 收集并记录数据包路由的统计信息
- 处理对端路由器的路由拓扑协议
- 收集并记录路由拓扑指标

拥有两个调度分区似乎是合理的，一个用于路由，一个用于拓扑。当然记录路由指标在功能上与数据包路由相关。

然而，但系统过载时，这就意味着机器无法完成更多出色的工作，你需要决定什么工作可以缓慢地处理。在这个例子中，当路由器因传入的数据包而过载时，路由这些数据仍然是很重要的。但是你可能会做如此决定，如果你无法完成所有操作，你宁愿路由数据而不是收集路由指标。通过同样的分析，你可能会得出这样的结论：路由拓扑协议应该继续运行，其使用的机器资源比路由本身少的多，但在需要时可以快速运行。

如此分析后需要3个分区：

- 一个分区用于路由数据包，占有很大份额，比如80%
- 一个分区用于拓扑协议，占比15%，但其最大线程优先级应高于数据包路由的优先级
- 一个分区用于记录路由指标和拓扑协议指标

在这种情况下，我们选择分离路由与记录路由指标的功能相关的组件，因为如果我们被迫挨饿某样东西，我们宁愿只挨饿一个。同样，我们选择将两个功能不相关的组件分组，一个记录路由指标，一个记录拓扑指标，因为我们想在相同的环境下让它们挨饿。(挨饿指处于空闲，不被CPU调度)



## 选择每个分区的CPU百分比

​	每个调度分区在未加载条件下倾向于使用的CPU时间量是你可以分配给它的预算的一个好迹象。如果你的应用程序是一个事务处理器，测量几种不同负载下的 CPU 消耗并构建提供的负载与消耗的 CPU 的图表可能很有用。

​	通常，获取正确的分区预算组合的关键是尝试一下方式：

- 关闭安全功能
- 用实际负载加载测试机器
- 使用IDE的系统分析器工具检查对时间敏感的线程的延迟
- 尝试不同的预算模式，你可以通过**aps**命令在运行时轻松的修改

Note: 你不能删除分区，但是你可以移除它的所有相应的进程，并且然后修改特定分区的预算为0%



### 设置预算为0

​	只要未设置 SCHED_APS_SEC_NONZERO_BUDGETS 安全标志，就可以将分区的预算设置为零。请查看**SchedCtl()**的**SCHED_APS_ADD_SECURITY**命令

​	在0预算的分区中的线程只能以如下情况运行：

- 你正使用默认调度策略(SCHED_APS_SCHEDPOL_DEFAULT)，并且系统中最高优先级的线程属于0预算分区
- 你正使用SCHED_APS_SCHEDPOL_FREETIME_BY_RATION，并且所有其他非零预算分区是空闲的
- 0预算分区拥有一个非零的临界预算，在这种情况下其关键线程将运行
- 线程从一个非零预算的分区接收消息，在这种情况下接收线程临时运行于发送者的分区

**何时设置分区的预算为0是有用的呢？**

在如下情况，设置分区的预算为0是有用的：

- 一个分区运行的线程永远为空；你可以设置它的预算为0来有效关闭该分区。当一个0预算分区空闲时，它不被认为会产生空闲时间(查看本指南线程调度器章节中的调度行为概述)。一个非零预算且从不运行线程的分区将线程调度器永远至于空闲时间模式，这可能并不是希望的行为。
- 当一些其他分区空闲时，你想要运行非关键的代码
- 该分区由资源管理器或其他软件构成，它仅在响应接收消息时运行。将它们放置于0预算分区意味着你不必为它们单独设计分区预算。(那些资源管理器自动将其时间计入其客户端的分区)

Note: 通常，不建议将一个分区预算设置为0。(这就是为何**SCHED_APS_RECOMMENDED**安全设置不允许分区预算为0)将代码放入0预算分区的主要风险是它可能会运行以响应一个脉冲或事件，因此而不在发送者分区中运行。结果就是，当系统加载时(例如没有空闲时间)，这些线程不可能运行，它们可能挂起，或者事情可能会以错误的顺序发生。

​	例如，将System分区的预算设置为0是危险的。在一个System分区预算为0的加载过的机器上，请求**procnto**创建进程和线程可能会挂起，例如当**MAP_LAZY**被使用时。此外，如果你的系统使用0预算的分区，当所有其他分区在一个while(1)循环中满载时，你应该小心地测试它。



### 为资源管理器设置预算

