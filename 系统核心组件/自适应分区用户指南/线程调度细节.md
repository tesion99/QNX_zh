# 线程调度细节

自适应分区线程调度程序是一个可选的线程调度程序，可让您保证线程、进程或应用程序组的 CPU 吞吐量的最小百分比。分配给分区的 CPU 百分比称为预算。

线程调度程序是在核心 QNX Neutrino RTOS 架构之上设计的，主要解决嵌入式系统设计中的两个问题：

- 在满载条件下正常运行
- 防止不重要或不受信任的应用程序垄断系统

我们称我们的分区是自适应的，因为它们的内容是动态的：

- 你可以将应用程序动态启动到分区中

- 子线程和子进程像其父进程一样，自动运行在相同的分区

- 默认情况下，当您使用标准 QNX Neutrino 发送-接收-回复消息传递时，消息接收方在处理该消息时会自动在消息发送方的分区中运行。

  这意味着所有资源管理器，例如驱动程序和文件系统，都会自动将 CPU 时间（开销除外）计入其客户的预算。

你可以通过命令行的**aps**命令或者在程序中调用**SchedCtl()**或**SchedCtl_r()**函数来控制自适应分区

Note:

​	在你调用**SchedCtl()**之前，请确保你传递给它的数据结构的所有成员被初始化。你可以使用**APS_INIT_DATA()**宏来实现。



## 跟踪 CPU 时间

自适应分区线程调度程序通过测量每个分区的平均 CPU 使用率来限制 CPU 使用率。 平均值是在平均窗口（通常为 100 毫秒）内计算的，该值是可配置的。

但是，线程调度程序不会等待 100 毫秒来计算平均值。 一旦 1 毫秒过去，这 1 毫秒的使用量就会添加到前 99 毫秒的使用量中，以计算平均窗口（即 100 毫秒）内的总 CPU 使用量。

窗口大小定义了平均时间；通过该时间，线程调度程序尝试将分区平衡到其保证的 CPU 限制。 您可以将平均窗口大小设置为 8 毫秒到 400 毫秒之间的任何值。

窗口大小的选择会影响平衡的准确性以及在极端情况下，还会影响运行线程的最大延迟。更多信息，请参考**线程调度器的注意事项**相关章节。

线程调度程序将花费的时间计入所用时钟滴答的实际部分。时间统计不仅在每个计时器滴答时完成，而且在每次线程开始或停止运行时完成。我们将此称为小额账单。



## CPU时间在分区间是如何分配的？

